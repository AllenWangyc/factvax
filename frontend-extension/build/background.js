"use strict";function a(e){h(e)}function h(e){e.data===void 0&&(e.data={}),e.method=e.method||"post";let t={},n=null;e.token&&(t.Authorization=`Bearer ${e.token}`),e.formData?(n=new FormData,Object.keys(e.data).forEach(function(s){n.append(s,e.data([s]))})):(t["Content-Type"]="application/json;charset=UTF-8",n=JSON.stringify(e.data));let o={method:e.method,headers:t,...e.method.toLowerCase()==="get"?{}:{body:n}};console.log(o),fetch(e.url,o).then(s=>s.json()).then(s=>{e.done&&e.done(),e.success&&e.success(s)}).catch(()=>{e.done&&e.done(),e.fail&&e.fail(API_FAILED)})}const c="https://fact-vax-app-e8d263b7267d.herokuapp.com/",u={detect:e=>new Promise((t,n)=>{e.url=c+"api/detect_text/default/",e.method="post",e.success=o=>{t(o)},a(e)}),getTokenByDeviceId:e=>new Promise((t,n)=>{e.url=c+`api/user/device?deviceId=${e.deviceId}`,e.method="get",e.success=o=>{t(o)},a(e)}),getUsernameByToken:e=>new Promise((t,n)=>{e.url=c+"api/user/user_name",e.method="get",e.success=o=>{t(o)},a(e)})};let d=[],r=null,i=!0;chrome.runtime.onInstalled.addListener(function(){chrome.action.disable(),chrome.declarativeContent.onPageChanged.removeRules(void 0,()=>{const t=[{conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{schemes:["https"]}})],actions:[new chrome.declarativeContent.ShowAction]}];chrome.declarativeContent.onPageChanged.addRules(t)})});chrome.runtime.onInstalled.addListener(()=>{i&&m()});chrome.contextMenus.onClicked.addListener((e,t)=>{e.menuItemId==="detect-text"&&chrome.tabs.sendMessage(t.id,{type:"getText",text:e.selectionText})});chrome.runtime.onMessage.addListener(async function(e,t,n){if(e.device_id){const o=e.device_id;console.log("Received device_id from content script:",o),await chrome.storage.local.set({device_id:o},function(){console.log("device_id stored in chrome.storage.")});const s=await u.getTokenByDeviceId({deviceId:o});if(console.log("The 'getTokenByDeviceId' response from backend is: ",s),s.accessToken){const l=s.accessToken;await chrome.storage.local.set({token:l},function(){console.log("Token stored in chrome.storage:",l)})}else console.error("Failed to retrieve token:",s)}if(e.username){const o=e.username;await chrome.storage.local.set({username:o},function(){console.log("username stored in chrome storage")})}return e.logout&&chrome.storage.local.remove(["token","username"],()=>{console.log("Token and username removed from background")}),!0});chrome.runtime.onMessage.addListener((e,t,n)=>{e.type==="INCREMENT_COUNTER"&&(r?(r.postMessage(e),console.log("The message posted to popup.")):(d.push(e),console.log("The message has been cached in messageQueue.")),n({success:!0})),e.type==="TOGGLE_CONTEXT_MENU"&&(i=e.enabled,p(),n({success:!0}))});chrome.runtime.onConnect.addListener(e=>{e.name==="popup"&&(r=e,d.forEach(t=>r.postMessage(t)),d=[],r.onDisconnect.addListener(()=>{r=null}))});chrome.runtime.onStartup.addListener(function(){chrome.storage.local.get(["device_id"],async function(e){if(e.device_id){const t=e.device_id;console.log("Device ID found on startup:",t);const n=await u.getTokenByDeviceId({deviceId:t});if(console.log("The 'getTokenByDeviceId' response from backend is: ",n),n.accessToken){const o=n.accessToken;await chrome.storage.local.set({token:o}),console.log("Token stored in chrome.storage on startup:",o)}else console.error("Failed to retrieve token on startup:",n)}else console.warn("No device_id found in chrome.storage on startup.")})});function m(){chrome.contextMenus.create({id:"detect-text",title:"Detect vinccine information",contexts:["selection"]})}function p(){chrome.contextMenus.removeAll(()=>{i&&m()})}
