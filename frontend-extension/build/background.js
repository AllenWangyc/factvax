"use strict";function r(e){u(e)}function u(e){e.data===void 0&&(e.data={}),e.method=e.method||"post";let t={},o=null;e.token&&(t.Authorization=`Bearer ${e.token}`),e.formData?(o=new FormData,Object.keys(e.data).forEach(function(n){o.append(n,e.data([n]))})):(t["Content-Type"]="application/json;charset=UTF-8",o=JSON.stringify(e.data));let s={method:e.method,headers:t,...e.method.toLowerCase()==="get"?{}:{body:o}};console.log(s),fetch(e.url,s).then(n=>n.json()).then(n=>{e.done&&e.done(),e.success&&e.success(n)}).catch(()=>{e.done&&e.done(),e.fail&&e.fail(API_FAILED)})}const c="https://fact-vax-app-e8d263b7267d.herokuapp.com/",l={detect:e=>new Promise((t,o)=>{e.url=c+"api/detect_text/default/",e.method="post",e.success=s=>{t(s)},r(e)}),getTokenByDeviceId:e=>new Promise((t,o)=>{e.url=c+`api/user/device?deviceId=${e.deviceId}`,e.method="get",e.success=s=>{t(s)},r(e)}),getUsernameByToken:e=>new Promise((t,o)=>{e.url=c+"api/user/user_name",e.method="get",e.success=s=>{t(s)},r(e)})};let d=[],a=null;chrome.runtime.onInstalled.addListener(function(){chrome.action.disable(),chrome.declarativeContent.onPageChanged.removeRules(void 0,()=>{const t=[{conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{schemes:["https"]}})],actions:[new chrome.declarativeContent.ShowAction]}];chrome.declarativeContent.onPageChanged.addRules(t)})});chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"detect-text",title:"Detect vinccine information",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((e,t)=>{e.menuItemId==="detect-text"&&chrome.tabs.sendMessage(t.id,{type:"getText",text:e.selectionText})});chrome.runtime.onMessage.addListener(async function(e,t,o){if(e.device_id){const s=e.device_id;console.log("Received device_id from content script:",s),await chrome.storage.local.set({device_id:s},function(){console.log("device_id stored in chrome.storage.")});const n=await l.getTokenByDeviceId({deviceId:s});if(console.log("The 'getTokenByDeviceId' response from backend is: ",n),n.accessToken){const i=n.accessToken;await chrome.storage.local.set({token:i},function(){console.log("Token stored in chrome.storage:",i)})}else console.error("Failed to retrieve token:",n);return!0}});chrome.runtime.onMessage.addListener((e,t,o)=>{e.type==="INCREMENT_COUNTER"&&(a?(a.postMessage(e),console.log("The message posted to popup.")):(d.push(e),console.log("The message has been cached in messageQueue.")),o({success:!0}))});chrome.runtime.onConnect.addListener(e=>{e.name==="popup"&&(a=e,d.forEach(t=>a.postMessage(t)),d=[],a.onDisconnect.addListener(()=>{a=null}))});chrome.runtime.onStartup.addListener(function(){chrome.storage.local.get(["device_id"],async function(e){if(e.device_id){const t=e.device_id;console.log("Device ID found on startup:",t);const o=await l.getTokenByDeviceId({deviceId:t});if(console.log("The 'getTokenByDeviceId' response from backend is: ",o),o.accessToken){const s=o.accessToken;await chrome.storage.local.set({token:s}),console.log("Token stored in chrome.storage on startup:",s)}else console.error("Failed to retrieve token on startup:",o)}else console.warn("No device_id found in chrome.storage on startup.")})});
