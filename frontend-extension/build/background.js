"use strict";function a(e){i(e)}function i(e){e.data===void 0&&(e.data={}),e.method=e.method||"post";let t={},s=null;e.token&&(t.Authorization=`Bearer ${e.token}`),e.formData?(s=new FormData,Object.keys(e.data).forEach(function(n){s.append(n,e.data([n]))})):(t["Content-Type"]="application/json;charset=UTF-8",s=JSON.stringify(e.data));let o={method:e.method,headers:t,...e.method.toLowerCase()==="get"?{}:{body:s}};console.log(o),fetch(e.url,o).then(n=>n.json()).then(n=>{e.done&&e.done(),e.success&&e.success(n)}).catch(()=>{e.done&&e.done(),e.fail&&e.fail(API_FAILED)})}const r="https://fact-vax-app-e8d263b7267d.herokuapp.com/",d={detect:e=>new Promise((t,s)=>{e.url=r+"api/detect_text/default/",e.method="post",e.success=o=>{t(o)},a(e)}),getTokenByDeviceId:e=>new Promise((t,s)=>{e.url=r+`api/user/device?deviceId=${e.deviceId}`,e.method="get",e.success=o=>{t(o)},a(e)}),getUsernameByToken:e=>new Promise((t,s)=>{e.url=r+"api/user/user_name",e.method="get",e.success=o=>{t(o)},a(e)})};chrome.runtime.onInstalled.addListener(function(){chrome.action.disable(),chrome.declarativeContent.onPageChanged.removeRules(void 0,()=>{const t=[{conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{schemes:["https"]}})],actions:[new chrome.declarativeContent.ShowAction]}];chrome.declarativeContent.onPageChanged.addRules(t)})});chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"detect-text",title:"Detect vinccine information",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((e,t)=>{e.menuItemId==="detect-text"&&chrome.tabs.sendMessage(t.id,{type:"getText",text:e.selectionText})});chrome.runtime.onMessage.addListener(async function(e,t,s){if(e.device_id){const o=e.device_id;console.log("Received device_id from content script:",o),await chrome.storage.local.set({device_id:o},function(){console.log("device_id stored in chrome.storage.")});const n=await d.getTokenByDeviceId({deviceId:o});if(console.log("The 'getTokenByDeviceId' response from backend is: ",n),n.accessToken){const c=n.accessToken;await chrome.storage.local.set({token:c},function(){console.log("Token stored in chrome.storage:",c)})}else console.error("Failed to retrieve token:",n);return!0}});chrome.runtime.onStartup.addListener(function(){chrome.storage.local.get(["device_id"],async function(e){if(e.device_id){const t=e.device_id;console.log("Device ID found on startup:",t);const s=await d.getTokenByDeviceId({deviceId:t});if(console.log("The 'getTokenByDeviceId' response from backend is: ",s),s.accessToken){const o=s.accessToken;await chrome.storage.local.set({token:o}),console.log("Token stored in chrome.storage on startup:",o)}else console.error("Failed to retrieve token on startup:",s)}else console.warn("No device_id found in chrome.storage on startup.")})});
